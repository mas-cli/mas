#
# .github/workflows/release.yml
#
---
name: release
on:
  release:
    types: [published]
defaults:
  run:
    # Force all run commands to not use Rosetta 2
    shell: arch -arm64 /bin/zsh {0}
env:
  GH_TOKEN: ${{github.token}}
  HOMEBREW_GITHUB_API_TOKEN: ${{secrets.HOMEBREW_GITHUB_API_TOKEN}}
  TAG_NAME: ${{github.event.release.tag_name}}
jobs:
  release:
    runs-on: macos-15
    steps:
      - name: üõí Checkout mas repo
        uses: actions/checkout@v4

      - name: üë¢ Bootstrap
        run: |
          script/bootstrap

      - name: üì¶ Build universal executable & package it in mas.pkg
        run: |
          script/package

      - name: üì§ Upload mas.pkg
        run: |
          gh release upload "${TAG_NAME}" .build/mas.pkg

      - name: üö∞ Bump mas-cli/tap/mas formula
        run: |
          brew tap mas-cli/tap
          brew bump-formula-pr \
            --tag "${TAG_NAME}" \
            --revision "$(git rev-parse "${TAG_NAME}")" \
            --no-fork \
            --no-browse \
            --online \
            --strict \
            --verbose \
            mas-cli/tap/mas

      - name: üç∫ Bump homebrew-core/mas formula
        # Bump homebrew-core/mas formula only if not a prerelease; all prerelease versions contain a '-'
        if: ${{!contains(env.TAG_NAME, '-')}}
        run: |
          brew bump-formula-pr \
            --tag "${TAG_NAME}" \
            --revision "$(git rev-parse "${TAG_NAME}")" \
            --fork-org mas-cli \
            --no-browse \
            --online \
            --strict \
            --verbose \
            mas
